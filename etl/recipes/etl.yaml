# steps:
# 0. filter asdr for all age
# 1. filter all age-specific groups from GBD
# 2. read standard population
# 3. run the asdr procedure
# 4. then bridge the WHO and GBD data


info:
    id: gm-vip-dataset
    base:
        - &gm  open-numbers/ddf--gapminder--gapminder_world
        - &gbd open-numbers/ddf--ihme--death_cause_compact
        - &geo open-numbers/ddf--open_numbers
    parameters:
        - bridge_length: &bridge_length 5

config:
    external_csv_dir: ../source
    procedure_dir: ./procedures

ingredients:
    - id: gm-datapoints
      dataset: *gm
      key: geo, time
      value: &indicators
          - murder_per_100000_people
          - murdered_men_per_100000_people
          - murdered_women_per_100000_people
          - murdered_children_0_14_per_100000_people
          - murdered_15_29_per_100000_people
          - murdered_30_44_per_100000_people
          - murdered_45_59_per_100000_people
          - murdered_60plus_per_100000_people
          - suicide_per_100000_people
          - suicide_men_per_100000_people
          - suicide_women_per_100000_people
          - suicide_age_0_14_per_100000_people
          - suicide_age_15_29_per_100000_people
          - suicide_age_30_44_per_100000_people
          - suicide_age_45_59_per_100000_people
          - suicide_age_60plus_per_100000_people
          - traffic_deaths_per_100000_people
          - traffic_deaths_men_per_100000_people
          - traffic_deaths_women_per_100000_people
          - traffic_mortality_children_0_14_per_100000_people
          - traffic_mortality_15_29_per_100000_people
          - traffic_mortality_30_44_per_100000_people
          - traffic_mortality_45_59_per_100000_people
          - traffic_mortality_60plus_per_100000_people
    - id: gbd-datapoints
      dataset: *gbd
      key: sex, age, cause, location, year
      value:
          - deaths_rate
    - id: gbd-locations
      dataset: *gbd
      key: location
      value: "*"
    - id: geo_synonyms
      dataset: *geo
      key: geo, synonym
      value: "*"
    - id: std_pop
      data: std_pop.csv
      key: age
    - id: geo-domain-country
      dataset: *geo
      key: country
      value:
          - name
    - id: concepts_hardcode
      key: concept
      data:
          - concept: name
            name: Name
            concept_type: string

cooking:
    entities:
        - procedure: serve
          ingredients:
              - geo-domain-country
          options:
              no_keep_sets: true
    concepts:
        - procedure: extract_concepts
          ingredients:
              - datapoints-final
          result: concepts-extracted
          options:
              include_keys: true
              overwrite:
                  country: entity_domain
                  time: time
        - procedure: merge
          ingredients:
            - concepts-extracted
            - concepts_hardcode
          result: concepts-final
          options:
              deep: true
    datapoints:
        # translating gbd country to use geo entity domain
        - procedure: translate_column
          ingredients:
              - gbd-locations
          result: gbd-locations-aligned
          options:
              dictionary:
                  base: geo_synonyms
                  key: synonym
                  value: geo
              column: medium_name
              target_column: geo

        # filter all data needed for GBD
        - procedure: translate_column
          ingredients:
              - gbd-datapoints
          options:
              dictionary:
                  "3": "0"
              column: "sex"
              not_found: include
          result: gbd-datapoints-sex-translated

        - procedure: filter
          ingredients:
              - gbd-datapoints-sex-translated
          result: gbd-datapoints-filtered-0
          options:
              row:
                  cause:
                      $in:
                          - "724"  # homicide
                          - "718"  # suicide
                          - "689"  # traffic
        - procedure: translate_column
          ingredients:
            - gbd-datapoints-filtered-0
          result: gbd-datapoints-aligned
          options:
              dictionary:
                  base: gbd-locations-aligned
                  key: location
                  value: geo
              column: location

        - procedure: translate_column
          ingredients:
            - gbd-datapoints-aligned
          result: gbd-datapoints-aligned-cause-translated
          options:
              dictionary:
                  "724": "homicide"
                  "718": "suicide"
                  "689": "traffic"
              column: cause

        - procedure: translate_header
          ingredients:
              - gbd-datapoints-aligned-cause-translated
          result: gbd-datapoints-aligned-translated
          options:
              dictionary:
                  "location": "geo"
                  "year": "time"

        # ASDR for all age
        - procedure: filter
          ingredients:
              - gbd-datapoints-aligned-translated
          result: gbd-datapoints-all-age
          options:
              row:
                  age:
                      $in:
                          - "27"  # Age Standardised
        - procedure: flatten
          ingredients:
            - gbd-datapoints-all-age
          result: gbd-datapoints-all-age-flattened
          options:
              flatten_dimensions:
                  - age
                  - sex
                  - cause
              dictionary:
                  "*": "{concept}_{sex}_{cause}_all_age"

        - procedure: translate_header
          ingredients:
              - gbd-datapoints-all-age-flattened
          result: gbd-datapoints-all-age-flattened-translated
          options:
              dictionary:
                  deaths_rate_0_homicide_all_age: murder_per_100000_people
                  deaths_rate_1_homicide_all_age: murdered_men_per_100000_people
                  deaths_rate_2_homicide_all_age: murdered_women_per_100000_people
                  deaths_rate_0_suicide_all_age: suicide_per_100000_people
                  deaths_rate_1_suicide_all_age: suicide_men_per_100000_people
                  deaths_rate_2_suicide_all_age: suicide_women_per_100000_people
                  deaths_rate_0_traffic_all_age: traffic_deaths_per_100000_people
                  deaths_rate_1_traffic_all_age: traffic_deaths_men_per_100000_people
                  deaths_rate_2_traffic_all_age: traffic_deaths_women_per_100000_people

        # ASDR for age groups
        # 0-14
        - procedure: filter
          ingredients:
            - gbd-datapoints-aligned-translated
          result: gbd-datapoints-0-14
          options:
              row:
                  age:
                      $in:
                          - "1"
                          - "6"
                          - "7"
                  sex:
                      - "0"
        - procedure: procedure.asdr
          ingredients:
              - gbd-datapoints-0-14
          result: gbd-datapoints-0-14-adsr
          options:
              standard_population: std_pop
              age_group_mapping:
                  "1": ["0-4"]
                  "6": ["5-9"]
                  "7": ["10-14"]
              age_column: "age"
              indicator_name: "death_rate_0_14"

        - procedure: flatten
          ingredients:
            - gbd-datapoints-0-14-adsr
          result: gbd-datapoints-0-14-adsr-flattened
          options:
              flatten_dimensions:
                  - sex
                  - cause
              dictionary:
                  "*": "{concept}_{cause}"

        - procedure: translate_header
          ingredients:
            - gbd-datapoints-0-14-adsr-flattened
          result: gbd-datapoints-0-14-adsr-flattened-translated
          options:
              dictionary:
                  death_rate_0_14_homicide: murdered_children_0_14_per_100000_people
                  death_rate_0_14_suicide: suicide_age_0_14_per_100000_people
                  death_rate_0_14_traffic: traffic_mortality_children_0_14_per_100000_people

        # 15-29
        - procedure: filter
          ingredients:
            - gbd-datapoints-aligned-translated
          result: gbd-datapoints-15-29
          options:
              row:
                  age:
                      $in:
                          - "8"
                          - "9"
                          - "10"
                  sex:
                      - "0"
        - procedure: procedure.asdr
          ingredients:
              - gbd-datapoints-15-29
          result: gbd-datapoints-15-29-adsr
          options:
              standard_population: std_pop
              age_group_mapping:
                  "8": ["15-19"]
                  "9": ["20-24"]
                  "10": ["25-29"]
              age_column: "age"
              indicator_name: "death_rate_15_29"

        - procedure: flatten
          ingredients:
            - gbd-datapoints-15-29-adsr
          result: gbd-datapoints-15-29-adsr-flattened
          options:
              flatten_dimensions:
                  - sex
                  - cause
              dictionary:
                  "*": "{concept}_{cause}"

        - procedure: translate_header
          ingredients:
            - gbd-datapoints-15-29-adsr-flattened
          result: gbd-datapoints-15-29-adsr-flattened-translated
          options:
              dictionary:
                  death_rate_15_29_homicide: murdered_15_29_per_100000_people
                  death_rate_15_29_suicide: suicide_age_15_29_per_100000_people
                  death_rate_15_29_traffic: traffic_mortality_15_29_per_100000_people

        # 30-44
        - procedure: filter
          ingredients:
            - gbd-datapoints-aligned-translated
          result: gbd-datapoints-30-44
          options:
              row:
                  age:
                      $in:
                          - "11"
                          - "12"
                          - "13"
                  sex:
                      - "0"
        - procedure: procedure.asdr
          ingredients:
              - gbd-datapoints-30-44
          result: gbd-datapoints-30-44-adsr
          options:
              standard_population: std_pop
              age_group_mapping:
                  "11": ["30-34"]
                  "12": ["35-39"]
                  "13": ["40-44"]
              age_column: "age"
              indicator_name: "death_rate_30_44"

        - procedure: flatten
          ingredients:
            - gbd-datapoints-30-44-adsr
          result: gbd-datapoints-30-44-adsr-flattened
          options:
              flatten_dimensions:
                  - sex
                  - cause
              dictionary:
                  "*": "{concept}_{cause}"

        - procedure: translate_header
          ingredients:
            - gbd-datapoints-30-44-adsr-flattened
          result: gbd-datapoints-30-44-adsr-flattened-translated
          options:
              dictionary:
                  death_rate_30_44_homicide: murdered_30_44_per_100000_people
                  death_rate_30_44_suicide: suicide_age_30_44_per_100000_people
                  death_rate_30_44_traffic: traffic_mortality_30_44_per_100000_people

        # 45-59
        - procedure: filter
          ingredients:
            - gbd-datapoints-aligned-translated
          result: gbd-datapoints-45-59
          options:
              row:
                  age:
                      $in:
                          - "14"
                          - "15"
                          - "16"
                  sex:
                      - "0"
        - procedure: procedure.asdr
          ingredients:
              - gbd-datapoints-45-59
          result: gbd-datapoints-45-59-adsr
          options:
              standard_population: std_pop
              age_group_mapping:
                  "14": ["45-49"]
                  "15": ["50-54"]
                  "16": ["55-59"]
              age_column: "age"
              indicator_name: "death_rate_45_59"

        - procedure: flatten
          ingredients:
            - gbd-datapoints-45-59-adsr
          result: gbd-datapoints-45-59-adsr-flattened
          options:
              flatten_dimensions:
                  - sex
                  - cause
              dictionary:
                  "*": "{concept}_{cause}"

        - procedure: translate_header
          ingredients:
            - gbd-datapoints-45-59-adsr-flattened
          result: gbd-datapoints-45-59-adsr-flattened-translated
          options:
              dictionary:
                  death_rate_45_59_homicide: murdered_45_59_per_100000_people
                  death_rate_45_59_suicide: suicide_age_45_59_per_100000_people
                  death_rate_45_59_traffic: traffic_mortality_45_59_per_100000_people

        # 60plus
        - procedure: filter
          ingredients:
            - gbd-datapoints-aligned-translated
          result: gbd-datapoints-60plus
          options:
              row:
                  age:
                      $in:
                          - "17"
                          - "18"
                          - "19"
                          - "20"
                          - "30"
                          - "31"
                          - "32"
                          - "235"
        - procedure: procedure.asdr
          ingredients:
              - gbd-datapoints-60plus
          result: gbd-datapoints-60plus-adsr
          options:
              standard_population: std_pop
              age_group_mapping:
                  "17": ["60-64"]
                  "18": ["65-69"]
                  "19": ["70-74"]
                  "20": ["75-79"]
                  "30": ["80-84"]
                  "31": ["85-89"]
                  "32": ["90-94"]
                  "235": ["95-99", "100+"]
              age_column: "age"
              indicator_name: "death_rate_60plus"

        - procedure: flatten
          ingredients:
            - gbd-datapoints-60plus-adsr
          result: gbd-datapoints-60plus-adsr-flattened
          options:
              flatten_dimensions:
                  - sex
                  - cause
              dictionary:
                  "*": "{concept}_{cause}"

        - procedure: translate_header
          ingredients:
            - gbd-datapoints-60plus-adsr-flattened
          result: gbd-datapoints-60plus-adsr-flattened-translated
          options:
              dictionary:
                  death_rate_60plus_homicide: murdered_60plus_per_100000_people
                  death_rate_60plus_suicide: suicide_age_60plus_per_100000_people
                  death_rate_60plus_traffic: traffic_mortality_60plus_per_100000_people


        - procedure: merge
          ingredients:
              - gbd-datapoints-all-age-flattened-translated
              - gbd-datapoints-0-14-adsr-flattened-translated
              - gbd-datapoints-15-29-adsr-flattened-translated
              - gbd-datapoints-30-44-adsr-flattened-translated
              - gbd-datapoints-45-59-adsr-flattened-translated
              - gbd-datapoints-60plus-adsr-flattened-translated
          result: gbd-datapoints-adsr-merged

        - procedure: trend_bridge
          ingredients: []
          result: datapoints-final
          options:
              bridge_start:
                  ingredient: gm-datapoints
                  column: *indicators
              bridge_end:
                  ingredient: gbd-datapoints-adsr-merged
                  column: *indicators
              bridge_on: time
              bridge_length: *bridge_length
              target_column: *indicators
        - procedure: serve
          ingredients:
              - datapoints-final
          options:
              digits: 4
